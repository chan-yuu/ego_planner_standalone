<launch>
  <!-- 地图尺寸参数 -->
  <arg name="map_size_x" default="40.0"/>
  <arg name="map_size_y" default="40.0"/>
  <arg name="map_size_z" default="3.0"/>
  
  <!-- 里程计话题 -->
  <arg name="odom_topic" default="/visual_slam/odom"/>
  
  <!-- ========== 1. 独立的 Grid Map 节点 ========== -->
  <node pkg="grid_map_standalone" name="grid_map_standalone" type="grid_map_node" output="screen">
    <remap from="/odom_world" to="$(arg odom_topic)"/>
    
    <param name="grid_map/resolution" value="0.1" type="double"/>
    <param name="grid_map/map_size_x" value="$(arg map_size_x)" type="double"/>
    <param name="grid_map/map_size_y" value="$(arg map_size_y)" type="double"/>
    <param name="grid_map/map_size_z" value="$(arg map_size_z)" type="double"/>
    
    <param name="grid_map/local_update_range_x" value="5.5" type="double"/>
    <param name="grid_map/local_update_range_y" value="5.5" type="double"/>
    <param name="grid_map/local_update_range_z" value="4.5" type="double"/>
    
    <!-- 障碍物膨胀半径 (重要！影响避障效果) -->
    <param name="grid_map/obstacles_inflation" value="0.25" type="double"/>
    
    <param name="grid_map/min_ray_length" value="0.1" type="double"/>
    <param name="grid_map/max_ray_length" value="4.5" type="double"/>
  </node>
  
  <!-- ========== 2. ROS Bridge 节点 ========== -->
  <node pkg="ros_bridge" name="ros_bridge_node" type="ros_bridge_node" output="screen">
    <remap from="/odom_world" to="$(arg odom_topic)"/>
  </node>
  
  <!-- ========== 3. Trajectory Server ========== -->
  <node pkg="ego_planner" name="traj_server" type="traj_server" output="screen">
    <remap from="/position_cmd" to="/planning/pos_cmd"/>
    <remap from="/odom_world" to="$(arg odom_topic)"/>
    <param name="traj_server/time_forward" value="1.0" type="double"/>
  </node>
  
  <!-- ========== 4. Waypoint Generator ========== -->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
    <remap from="~odom" to="$(arg odom_topic)"/>        
    <remap from="~goal" to="/move_base_simple/goal"/>
    <remap from="~traj_start_trigger" to="/traj_start_trigger"/>
    <param name="waypoint_type" value="manual-lonely-waypoint"/>    
  </node>
  
  <!-- ========== 5. Simulator ========== -->
  <include file="$(find ego_planner)/launch/simulator.xml">
    <arg name="map_size_x_" value="$(arg map_size_x)"/>
    <arg name="map_size_y_" value="$(arg map_size_y)"/>
    <arg name="map_size_z_" value="$(arg map_size_z)"/>
    <arg name="c_num" value="200"/>
    <arg name="p_num" value="50"/>
    <arg name="min_dist" value="0.2"/>
    <arg name="odometry_topic" value="$(arg odom_topic)"/>
  </include>
  
  <!-- ========== 6. RViz ========== -->
  <node type="rviz" name="rviz" pkg="rviz" args="-d $(find ego_planner)/launch/rviz_config/rviz_config.rviz"/>
  
</launch>
